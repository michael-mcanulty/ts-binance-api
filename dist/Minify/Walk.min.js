"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs=require("fs"),path=require("path"),MatcherCollection=require("matcher-collection"),ensurePosix=require("ensure-posix-path"),Options_1=require("./Options"),Entry_1=require("./Entry");class Walk{_fullpath(t){return`${this.baseDir}/${t}`}_getStat(t){let e;try{e=fs.statSync(t)}catch(t){if("ENOENT"!==t.code)throw t}return e}_handleOptions(t){let e;return Array.isArray(t)?(e=new Options_1.Options).globs=t:t&&(e=Options_1.Options.toOptions(t)),e}_handleRelativePath(t){return null==t?"":"/"!==t.slice(-1)?t+"/":t}_walkSync(t,e,i){e&&(this.baseDir=ensurePosix(this.baseDir));let r,s,a=this._handleRelativePath(t),n=this.options.globs,l=this.options.ignore,o=[];if(l&&(s=new MatcherCollection(l)),n&&(r=new MatcherCollection(n)),r&&!r.mayContain(a))return o;let h=fs.readdirSync(this._fullpath(a)).map(t=>{let e=a+t;if(s&&s.match(e))return;let i=this._fullpath(e),r=this._getStat(i);return r&&r.isDirectory()?new Entry_1.Entry(this.baseDir,r.mode,r.mtime.getTime(),e+"/",r.size):new Entry_1.Entry(this.baseDir,r.mode,r.mtime.getTime(),e,r.size)}).filter(Boolean).sort((t,e)=>{let i=t.relativePath,r=e.relativePath;return i===r?0:i<r?-1:1});for(let t=0;t<h.length;++t){let e=h[t];e.isDirectory()?(!1===this.options.directories||r&&!r.match(e.relativePath)||(this.options.callback&&i(e),o.push(e)),o=o.concat(this._walkSync(e.relativePath))):r&&!r.match(e.relativePath)||(this.options.callback&&i(e),o.push(e))}return o}entries(){return this._walkSync(null,!0)}sync(){let t;return t=this.options.includeBasePath?t=>t.basePath.split(path.sep).join("/")+"/"+t.relativePath:t=>t.relativePath,this._walkSync().map(t)}constructor(t,e){this.baseDir=t,this.options=this._handleOptions(e)}}exports.Walk=Walk;