{"version":3,"file":"WsBinance.js","sourceRoot":"","sources":["../../src/Websocket/WsBinance.ts"],"names":[],"mappings":"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","sourcesContent":["import * as Html5WebSocket from 'html5-websocket'\nimport {default as ReconnectingWebSocket, iReconWSOptions} from \"./ReconnectingWebSocket/ReconnectingWebSocket\";\nimport {iStreamTickerRaw} from \"../ExchangeInfo/Interfaces/iStreamTickerRaw\";\nimport {Price} from \"../Transaction/Price\";\nimport {Ticker} from \"../ExchangeInfo/ticker\";\nimport {iBinanceOptions} from \"../Binance/Interfaces/iBinanceOptions\";\nimport {BinanceRest} from \"../Rest/BinanceRest\";\n\nexport class WsBinance extends BinanceRest{\n\tprivate _cache: any;\n\tprivate readonly _reconOptions: iReconWSOptions = <iReconWSOptions>{};\n\tprivate _ws: ReconnectingWebSocket;\n\tpublic base: string = 'wss://stream.binance.com:9443/ws';\n\tprivate isAlive:boolean = false;\n\tpublic options: iBinanceOptions;\n\n\tprivate _url: string;\n\n\tget url(): string {\n\t\treturn this._url;\n\t}\n\n\tset url(value: string) {\n\t\tthis._url = value;\n\t}\n\n\tprivate _getTickerUrl(symbol?: string | null): string {\n\t\tif (symbol && symbol !== null) {\n\t\t\treturn `${this.base}/${symbol.toLowerCase()}@ticker`;\n\t\t} else {\n\t\t\treturn `${this.base}/!ticker@arr`;\n\t\t}\n\t}\n\n\tpublic cache(payload: any | any[]): any[] {\n\t\treturn Array.isArray(payload) ? payload : [payload];\n\t}\n\n\tpublic getPrices(cb: Function) {\n\t\tlet ticksToPrices = (tickers: Ticker[]) => {\n\t\t\tlet prices: Price[] = tickers.map(t => {\n\t\t\t\treturn t.toPrice()\n\t\t\t});\n\t\t\tcb(prices);\n\t\t};\n\t\tthis.getTickers(ticksToPrices);\n\t}\n\n\tpublic getTickers(cb: Function): any {\n\t\tlet tickers: Ticker[];\n\t\tlet w: ReconnectingWebSocket = this.openWebSocket(this._getTickerUrl(null));\n\t\tw.onmessage = msg => {\n\t\t\tlet res: iStreamTickerRaw[];\n\t\t\tres = JSON.parse(msg.data);\n\t\t\ttickers = res.map((raw: iStreamTickerRaw) => {\n\t\t\t\treturn new Ticker(raw);\n\t\t\t});\n\t\t\tcb(tickers);\n\t\t};\n\n\t\treturn (options) => this._cache.forEach(w => w.close(1000, 'Close handle was called', {keepClosed: true, ...options}));\n\t}\n\n\tpublic getUser():Promise<any> {\n\t\treturn new Promise(async (resolve, reject) => {\n\t\t\tconst keepStreamAlive = (method, listenKey) => () => method({listenKey});\n\t\t\tthis.user = async cb => {\n\t\t\t\tthis.listenKey = await this.getDataStream();\n\t\t\t\tconst w = this.openWebSocket(`${this.base}/${this.listenKey}`)\n\t\t\t\tw.onmessage = (msg) => (this.userEventHandler(cb)(msg));\n\n\t\t\t\tconst int = setInterval(keepStreamAlive(this.keepDataStream, this.listenKey), 50e3);\n\t\t\t\tkeepStreamAlive(this.keepDataStream, this.listenKey)();\n\n\t\t\t\tlet result = async (options) => {\n\t\t\t\t\tclearInterval(int);\n\t\t\t\t\tawait this.closeDataStream();\n\t\t\t\t\tw.close(1000, 'Close handle was called', {keepClosed: true, ...options});\n\t\t\t\t};\n\t\t\t\tresolve(result);\n\t\t\t}\n\t\t});\n\t}\n\n\tprivate heartbeat():void{\n\t\tsetInterval(async ()=>{\n\t\t\ttry{\n\t\t\t\tthis.isAlive = await this.ping();\n\t\t\t\tif(!this.isAlive){\n\t\t\t\t\tconsole.log(\"Lost Connectivity. Restart the server using process.exit(0)\");\n\t\t\t\t}\n\t\t\t}catch(err){\n\t\t\t\t//TODO: pass in a callback or kill process.\n\t\t\t\t//TODO: IMPORTANT. Create Error with proper code i.e code: 1001.\n\t\t\t\t//process.exit(0);\n\t\t\t}\n\t\t}, 3000);\n\t}\n\n\tpublic openWebSocket(url): ReconnectingWebSocket {\n\t\tif (url) {\n\t\t\tthis.url = url;\n\t\t\tthis._ws = new ReconnectingWebSocket(this.url, undefined, this._reconOptions);\n\t\t\treturn this._ws;\n\t\t}\n\t}\n\n\tconstructor(options: iBinanceOptions) {\n\t\tsuper(options);\n\t\tthis.options = options;\n\t\tthis._reconOptions = <iReconWSOptions>{};\n\t\tthis._reconOptions.connectionTimeout = 4E3;\n\t\tthis._reconOptions.constructor = typeof window !== 'undefined' ? WsBinance : Html5WebSocket;\n\t\tthis._reconOptions.debug = false;\n\t\tthis._reconOptions.maxReconnectionDelay = 10E3;\n\t\tthis._reconOptions.maxRetries = Infinity;\n\t\tthis._reconOptions.minReconnectionDelay = 4E3;\n\t\tthis.heartbeat();\n\t}\n}"]}